pipeline:
  restore-cache:
    image: drillster/drone-volume-cache
    restore: true
    mount:
      - ./node_modules
    volumes:
      - /tmp/cache:/cache

  build:
    image: simontegg/alpine-node-git
    commands:
      - npm install
      - npm run build
    cache:
      mount: 
        - node_modules
        - .git

  rebuild-cache:
    image: drillster/drone-volume-cache
    rebuild: true
    mount:
      - ./node_modules
    volumes:
      - /tmp/cache:/cache

  test:
    image: simontegg/alpine-node-git
    commands:
      - npm test

  docker:
    image: plugins/docker
    registry: r.cfcr.io
    repo: r.cfcr.io/simontegg/simontegg/enterprisestack
    secrets: [docker_username, docker_password]

  rancher:
    image: peloton/drone-rancher
    url: http://104.237.4.81:8080
    secrets: [PLUGIN_ACCESS_KEY, PLUGIN_SECRET_KEY]
    service: accreditron/staging
    docker_imagep: r.cfcr.io/simontegg/simontegg/enterprisestack
    timeout: 360
    confirm: true
  
